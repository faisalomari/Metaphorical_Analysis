/*******************************************************
 *  AUTOMATIC POETRY SENDER — THIRD POEM
 *  - For YOUR ChatGPT UI (ProseMirror + composer button)
 *  - Sends each FULL verse (صدر + عجز)
 *  - 20 seconds delay between messages
 *  - Use: window.stopScript = true; to stop any time
 *******************************************************/

window.stopScript = false;

const poem = [
"يا دار ميّة بالعلياء، فالسندِ    أقوَتْ، وطال عليها سالف الأبدِ",
"وقفت فيها أُصيلاناً أُسائِلها،    عَيّتْ جواباً، وما بالربع من أحدِ",
"إلا الأواريَّ لأياً ما أُبيّنها،    والنؤي كالحوض بالمظلومة الجلدِ",
"ردّت عليه أُقاصيه، ولبّده    ضرب الوليدة بالمسحاة في الثأدِ",
"خلّت سبيل أتِيٍّ كانَ يحبسهُ،    ورفّعتهُ إلى السّجفَيْن ، فالنّضَدِ",
"أمست خلاء ، وأمسى أهلها احتملوا    أخنى عليها الذي أخنى على لُبَدِ",
"فعَدّ عَمّا ترى ، إذ لا ارتجاع له،    وانمِ القُتُودَ على عَيْرانة ٍ أُجُدِ",
"مقذوفة ٍ بدخيس النحض، بازِلُها    له صريفٌ، صريف القَعْوِ بالمسَدِ",
"كأن رحلي، وقد زال النهار بنا،    يوم الجليل، على مستأنسٍ وحدِ",
"من وحش وَجرة َ ، مَوشيٍّ أكارعُهُ ،    طاوي المصير، كسيف الصيقل الفَرَدِ",
"سرَتْ عليه ، من الجوزاء ، سارية ٌ،    تُزجي الشّمال عليه جامد البَرَدِ",
"فارتاع من صوت كلّابٍ ، فبات له    طوع الشوامت من خوفٍ ومن صَرَدِ",
"فبثّهنّ عليه، واستمرّ به    صُمْعُ الكعوبِ بريئاتٌ من الحَرَدِ",
"وكان ضُمْران منه حيث يوزعهُ،    طعن المُعارك عند المُحجر النّجُدِ",
"شكّ الفَريصةَ بالمِدرى، فأنفَذَها،    طعْنَ المُبيطرِ، إذ يَشفي من العَضَدِ",
"كأنّه، خارجاً من جنب صفحته،    سفّودُ شَرْبٍ نسوهُ عند مُفتأدِ",
"فظلّ يعجمُ أعلى الرّوق، منقبضاً،    في حالك اللون صَدقٍ ، غير ذي أوَدِ",
"لما رأى واشقٌ إقعاص صاحبهِ ،    ولا سبيل إلى عقلٍ، ولا قودِ",
"قالت له النفس: إني لا أرى طمعاً ،    وإن مولاك لم يسلم، ولم يصدِ",
"فتلك تُبْلغني النعمانَ ، إن له    فضلاً على الناس في الأدنى ، وفي البَعَدِ",
"ولا أرى فاعلاً ، في الناس ، يُشبهه ،    ولا أُحاشي، من الأقوام، من أحدِ",
"إلا سليمان ، إذ قال الإله له:    قم في البرية، فاحدُدها عن الفَنَدِ",
"وخيّس الجن! إني قد أذنت لهم    يبنون تدمر بالصُّفّاح والعَمَدِ",
"فمن أطاعك ، فانفَعهُ بطاعتهِ ،    كما أطاعك، وادلُلْـهُ على الرّشَدِ",
"ومن عصاك، فعاقبْهُ معاقبة ً    تنهى الظلوم، ولا تقعد على ضَمَدِ",
"إلا لمثلك، أو مَنْ أنت سابقُهُ    سبق الجواد، إذا استولى على الأمَدِ",
"أعطى لفارهةٍ، حلوٍ توابعها،    من المواهب لا تعطى على نَكَدِ",
"الواهبُ المائة المعكاء، زيّنها    سعدانُ توضح في أوبارها اللّبَدِ",
"والأدْمَ قد خُيِّست، فُتلاً مرافقها    مشدودة ً برحال الحيرة الجُدُدِ",
"والراكضاتِ ذيولَ الريط، فانقها    بردُ الهواجرِ، كالغزلان بالجرَدِ",
"والخَيل تمزغُ غرباً في أعنّتها،    كَالطير تنجو من الشؤبوب ذي البرَدِ",
"احكُمْ كحكم فتاة الحي، إذ نظرت    إلى حمامِ شراعٍ ، وارد الثّمّدِ",
"يحفّه جانبا نيقٍ، وتُتبِعُهُ    مثل الزجاجة، لم تكحلْ من الرُمَدِ",
"قالت: ألا ليتما هذا الحمامُ لنا    إلى حمامتنا ونصفُهُ، فَقَدِ",
"فحسّبوه، فألفَوهُ، كما حَسَبَتْ،    تسعاً وتسعين لم تنقص ولم تَزِدِ",
"فكمّلت مائة ًفيها حمامتها،    وأسرعت حسبة ًفي ذلك العَدَدِ",
"فلا لعمرُ الذي مسّحتُ كعبته،    وما هُريق، على الأنصاب، من جسدِ",
"والمؤمنِ العائذاتِ الطّيرَ، تمسحها    رُكبانُ مكَة بين الفَيلِ والسّعَدِ",
"ما قلتُ من سيّيء مما أُتيتَ به،    إذاً فلا رفعت سوطي إليَّ يدي",
"إلا مقالةَ أقوامٍ شقيتُ بها،    كانت مقَالتُهم قرعاً على الكَبِدِ",
"إذاً فعاقبني ربي معاقبةً،    قرّت بها عينُ مَنْ يأتيك بالفَنَدِ",
"أُنبئتُ أن أبا قابوس أوعدني،    ولا قرار على زأْرٍ من الأسَدِ",
"مهلاً، فِداءٌ لك الأقوام كلِّهُمُ،    وما أُثمّرُ من مالٍ ومنْ ولَدِ",
"لا تَقذفنَي برُكْنٍ لا كفاء له،    وإن تأثّفَكَ الأعداء بالرّفَدِ",
"فما الفُرات، إذا جاشت غواربه    ترمي أواذيُّهُ العبرينِ بالزّبَدِ",
"يمُدّهُ كلُّ وادٍ مُترعٍ، لجبٍ،    فيه ركامٌ من الينبوتِ والخضدِ",
"يظلّ، من خوفه، الملّاحُ معتصماً    بالخيزُرانةِ، بعد الأينِ والنّجَدِ",
"يوماً، بأجود منه سيب نافلةٍ،    ولا يحولُ عطاءُ اليوم دون غَدِ",
"هذا الثَّناءُ، فإنْ تسمعْ به حسناً،    فلم أُعرّض، أبيتَ اللّعن، بالصّفَدِ",
"ها إن ذي عذرة ٌ إلا تكن نفعت،    فإن صاحبها مشاركُ النّكَدِ"
];

let i = 0;

/************** WRITE INTO CHATGPT INPUT **************/
function writeMessage(text) {
    const editor = document.querySelector("#prompt-textarea");
    if (!editor) return alert("❌ Cannot find ChatGPT input editor (#prompt-textarea).");

    editor.innerHTML = `<p>${text.replace(/\n/g, "<br>")}</p>`;
    editor.dispatchEvent(new Event("input", { bubbles: true }));
    editor.focus();
}

/************** CLICK SEND BUTTON **************/
function clickSend() {
    const btn = document.querySelector("#composer-submit-button");
    if (!btn) return alert("❌ Cannot find send button (#composer-submit-button).");
    btn.click();
}

/************** WAIT FOR CHATGPT TO FINISH **************/
function waitForFinish(callback) {
    const observer = new MutationObserver(() => {
        const typing = document.querySelector("[data-testid='bot-typing']");
        if (!typing) {
            observer.disconnect();
            setTimeout(callback, 500);
        }
    });
    observer.observe(document.querySelector("main"), {
        childList: true,
        subtree: true
    });
}

/************** MAIN LOOP **************/
function run() {
    if (window.stopScript) {
        console.log("⛔ Script stopped manually.");
        return;
    }

    if (i >= poem.length) {
        console.log("✔️ Finished sending entire poem!");
        return;
    }

    const msg = `البيت رقم ${i + 1}:\n${poem[i]}`;
    console.log("➡️ Sending:", msg);

    writeMessage(msg);

    // 20 SECOND DELAY BEFORE SENDING
    setTimeout(() => {
        clickSend();
        waitForFinish(run);
    }, 10000);

    i++;
}

// START
run();
