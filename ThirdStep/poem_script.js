/************************************************************
 *  FULL AUTOMATIC CHATGPT POETRY SENDER — VERSION C
 *  Sends EACH verse with ONE rhetorical element per message
 *  After finishing all elements for a verse → sends:
 *       "قم بجدول تلخيصي"
 ************************************************************/

const poem = [
"قِفَا نَبْكِ من ذِكْرَى حَبِيبٍ ومنزلِ    بِسِقْطِ اللِّوى بَيْنَ الدَّخُولِ فَحَوْمَلِ",
"فَتُوضِحَ فالمِقْراةِ لم يَعْفُ رسْمُهَا    لِمَا نَسَجَتْهَا منْ جَنُوبٍ وشَمْألِ",
"تَرَى بَعَرَ الأرْآمِ في عَرَصَاتِها    وقِيْعَانِها كَأنَّهُ حَبُّ فُلْفُلِ",
"كَأنِّي غَدَاةَ البَيْنِ يَوْمَ تَحَمَّلوا    لَدَى سَمُراتِ الحَيِّ نَاقِفُ حَنْظَلِ",
"وُقُوفاً بها صَحْبِي عَلَيَّ مَطِيَّهُمْ    يَقُولُونَ لا تَهلِكْ أسًى وَتَجمَّلِ",
"وإنَّ شِفَائي عَبْرَة ٌ مُهَرَاقَة ٌ    فَهَلْ عِنْدَ رَسْمٍ دارِسٍ من مُعَوَّلِ",
"كَدَأْبِكَ منْ أمِّ الحُوَيْرِث قَبْلَهَا    وجَارَتِهَا أمَّ الرَّبابِ بِمَأَسِلِ",
"إذا قَامَتَا تَضَوَّعَ المِسْكُ مِنْهُمَا    نَسِيْمَ الصَّبَا جَاءَتْ بِرَيَّا القَرَنْفُلِ",
"فَفَاضَتْ دُمُوعُ العَيْنِ مِنِّي صَبَابَةً    عَلى النَّحْرِ حتّى بَلَّ دَمْعِيَ مِحْمَلي",
"ألا رُبَّ يَوْمٍ لَكَ مِنْهُنَّ صَالِحٍ    ولا سِيَّمَا يَوْمٍ بِدَارَة ِ جُلْجُلِ",
"ويَوْمَ عَقَرْتُ للعَذَارَى مَطِيَّتي    فَيَا عَجَباً لِرَحْلِهًا المُتَحَمَّلِ",
"فَظَلَّ العَذَارَى يَرْتَمينَ بِلَحْمِهَا    وشَحْمٍ كَهُدَّابِ الدِّمَقْسِ المُفَتَّلِ",
"ويَوْمَ دَخَلْتُ الخِدْرِ خِدْرَ عُنَيْزَةٍ    فَقَالَتْ لَكَ الوَيْلَاتُ إنَّكَ مُرْجِلِي",
"تَقُولُ وقَدْ مَالَ الغَبِيْطُ بَنَا مَعاً    عَقَرْتَ بَعِيْرِي يا امْرَأ القَيْسِ فَانْزِلِ",
"فَقُلْتُ لَهَا سِيْرِي وأرْخِي زِمَامَهُ    ولا تُبْعِدِيني مِنْ جَنَاكِ المُعَلَّلِ",
"فَمِثْلِكِ حُبْلَى قَدْ طَرَقْتُ ومُرْضِعٍ    فألْهَيْتُهَا عَنْ ذِيْ تَمَائِمَ مُحْوِلِ",
"إذا ما بَكَى منْ خَلْفَهَا انْصَرَفَتْ لَهُ    بِشِقٍ وَتَحْتِي شِقُّهَا لَمْ يُحَوَّلِ",
"ويَوْمٍ عَلَى ظَهْرِ الكَثِيْبِ تَعَذَّرَتْ    عَليَّ وَآلَتْ حَلْفَة ً لم تَحَلَّلِ",
"أفَاطِمَ مَهْلاً بَعْضَ هذا التَّدَلُلِ    وإنْ كُنْتِ قَدْ أزْمَعْتِ صرمْي فَأجْمِلِي",
"أغَرّكِ مِنِّي أنَّ حُبَّكِ قَاتِلي    وأنَّكِ مِهْمَا تأمُرِي القَلْبَ يَفْعَلِ",
"فإنْ تَكُ قَدْ ساءَتْكِ مِنِّي خَلِيْقَة ٌ    فَسُلِّي ثِيَابِي منْ ثِيَابِكِ تَنْسُلِ",
"وَمَا ذَرَفَتْ عَيْنَاكِ إلَّا لتَضْرِبي    بِسَهْمَيْكِ في أعشَارِ قَلْبٍ مُقَتَّلِ",
"وبَيْضَةِ خِدْرٍ لا يُرَامُ خَبَاؤُهَا    تَمَتَّعْتُ منْ لَهْوٍ بها غَيْرَ مُعْجَلِ",
"تَجَاوَزْتُ أهْوالًا إلَيْهَا ومَعْشَراً    عَليَّ حِرَاصًا لو يُسِرُّون مَقْتَلِي",
"إذا ما الثُّرَيَّا في السَّمَاءِ تَعَرَّضَتْ    تَعَرَّضَ أثْنَاءِ الوِشَاحِ المُفَصَّلِ",
"فَجِئْتُ وقَدْ نَضَتْ لِنَوْمٍ ثِيَابَهَا    لَدَى السِّتْرِ إلَّا لِبْسَةَ المُتَفَضِّلِ",
"فَقَالَتْ يَمِيْنَ الله ما لَكَ حِيْلَةٌ    وما إنْ أرَى عَنْكَ الغَوَايَةَ تَنْجَلِي",
"فَقُمْتُ بِهَا أمْشِي تَجُرُّ وَرَاءَنَا    عَلَى إِثْرِنَا أذْيَالَ مِرْطٍ مُرَحَّلِ",
"فَلَمَّا أجَزْنَا سَاحَةَ الحَيِّ وانْتَحَى    بِنَا بَطْنُ خَبْتٍ ذي قِفَافٍ عَقَنْقَلِ",
"هَصَرْتُ بِفْودَي رَأْسِهَا فَتَمَايَلَتْ    عَلَيَّ هَضِيْمَ الكَشْحِ رَيَّا المُخَلْخَلِ",
"مُهَفْهَفَة ٌ بَيَضَاءُ غَيْرُ مُفَاضَة ٍ    تَرَائَبُها مَصْقُولَةٌ كالسَّجَنْجَلِ",
"تَصُدُّ وتُبْدِي عَنْ أسِيْلٍ وتَتَّقِي    بِنَاظِرَةٍ منْ وَحْشِ وَجْرَةَ مُطْفِلِ",
"وجِيْدٍ كَجِيْدِ الرِّئْمِ لَيْسَ بِفَاحِشٍ    إذا هيَ نَصَّتْهُ وَلَا بمُعَطَّلِ",
"غَدَائِرُهُ مُسْتَشْزَرَاتٌ إلى العُلا    تَضِلُّ العِقَاصُ في مُثَنًّى وَمُرْسَلِ",
"وكَشْحٍ لَطِيْفٍ كَالجَديْلِ مُخَصَّرٍ    وسَاقٍ كَأنْبُوبِ السَّقِيِّ المُذَلَّلِ",
"وَيُضْحِي فَتِيْتُ المِسْكِ فَوْقَ فِرَاشِهَا    نَؤُومُ الضُّحَى لم تَنْتَطِقْ عنْ تَفَضُّلِ",
"وتَعْطُو بِرَخْصٍ غَيْرِ شَثْنٍ كَأنَّهُ    أسارِيْعُ ظَبْيٍ أوْ مَسَاوِيْكُ إِسْحِلِ",
"تُضِيءُ الظَّلامَ بالعِشَاءِ كَأنَّهَا    مَنَارَة ُ مُمْسَى رَاهِبٍ مُتَبَتِّلِ",
"إلَى مِثْلهَا يَرْنُو الحَلِيْمُ صَبَابَةً    إذا ما اسْبَكَرَّتْ بَيْنَ دِرْعٍ ومِجْوَلِ",
"كَبِكْرِ المُقَانَاةِ البَيَاضَ بِصُفْرَةٍ    غَذَاهَا نَمِيْرُ الماءِ غَيْرُ مُحَلَّلِ",
"تَسَلَّت عمَايَاتُ الرِّجالِ عن الصِّبَا    وَلَيْسَ فُؤَادي عَنْ هَوَاكِ بِمُنْسَلِي",
"ألا رُبَّ خَصْمٍ فيكِ ألْوَى رَدَدْتُهُ    نَصِيْحٍ عَلَى تَعْذَالِهِ غَيْرَ مُؤْتَلِي",
"ولَيْلٍ كموج البَحْر مُلْقٍ سُدُولَهُ    عليَّ بأنْوَاعِ الهُمُومِ لِيَبْتَلِي",
"فَقُلْتُ لَهُ لـــمَّا تَمَطَّى بِصُلْبِهِ    وأرْدَفَ أعْجَازًا ونَاءَ بِكَلْكَلِ",
"ألَا أيُّها اللَّيْلُ الطَّوِيْلُ ألا انْجَلِي    بِصُبْح وما الإصْبَاحُ فِيْكَ بأمْثَلِ",
"فَيَا لَكَ من لَيْلٍ كأنَّ نُجُومَهُ    بِكُلِّ مُغَارِ الفَتْلِ شُدَّتْ بِيَذْبُلِ",
"كأنَّ الثُّريَّا عُلِّقَتْ في مَصَامِهَا    بأمْرَاسِ كَتَّانٍ إلى صُمِّ جَنْدَلِ",
"وقِربَةِ أقْوَامٍ جَعَلْتُ عِصَامَهَا    على كَاهِلٍ مِنِّي ذَلُولٍ مُرَجَّلِ",
"ووادٍ كَجَوُفِ العَيْرِ قَفرٍ قَطَعْتُهُ    به الذِّئْبُ يَعْوِي كالخَلِيع المُعَيَّلِ",
"فقلتُ له لمَّا عَوَى إنَّ شَأنَنَا    طَوِيْلُ العَنَا إنْ كُنْتَ لـــمَّا تَمَوَّلِ",
"كِلًانَا إذَا ما نَالَ شَيْئًا أفَاتَهُ    ومَنْ يَحْتَرِثْ حَرْثِي وحَرْثَكَ يُهْزَلِ",
"وقد أغتدي والطَّيْرُ في وُكُنَاتِهَا    بمنجردٍ قَيْدِ الأوَابِدِ هَيْكَلِ",
"مِكَرٍّ مِفَرٍّ مُقبِلٍ مُدبِرٍ مَعاً    كَجُلمُودِ صَخْرٍ حَطَّهُ السَّيْلُ مِنْ عَلِ",
"كُمَيْتٍ يَزِلُّ اللِّبْدُ عَنْ حَالِ مَتْنِهِ    كَمَا زَلَّتِ الصَّفْوَاءُ بِالمُتَنَزَّلِ",
"على الذَّبْلِ جَيَّاشٌ كأنَّ اهْتِزَامَهُ    إذا جَاشَ فِيهِ حَمْيُهُ غَلْيُ مِرْجَلِ",
"مِسَحٍّ إذا ما السَّابِحَاتُ على الوَنَى    أثَرْنَ الغُبَارَ بالكَدِيدِ المُرَكَّلِ",
"يَزِلُّ الغُلَامُ الخِفُّ عَنْ صَهَواتِهِ    ويُلوِي بأثْوَابِ العَنَيْفِ المُثَقَّلِ",
"دَرِيْرٍ كَخُذْرُوفِ الوَليْدِ أمَرَّهُ    تَتَابعُ كَفَّيْهِ بِخَيْطٍ مُوَصَّلِ",
"لَهُ أَيْطَلا ظَبْيٍ وسَاقَا نَعَامَةٍ    وإرخَاءُ سرْحَانٍ وتَقْرِيْبُ تَتْفُلِ",
"ضَلِيْعٍ إذَا اسْتَدْبَرْتَهُ سَدَّ فَرْجَهُ    بِضَافٍ فُوَيْقَ الأرْضِ لَيْسَ بأعْزَلِ",
"كأنَّ سَرَاتَهُ لَدَى البَيْتِ قَائمًا    مَدَاكُ عَرُوسٍ أوْ صَلَايَةُ حَنْظَلِ",
"كَأنَّ دِمَاءَ الهَادِيَاتِ بِنَحْرِهِ    عُصَارَةُ حِنَّاءٍ بِشَيْبٍ مُرَجَّلِ",
"فَعَنَّ لَنَا سِرْبٌ كأنَّ نِعَاجَهُ    عذَارَى دَوَارٍ في مُلاءٍ مُذَيَّلِ",
"فَأدْبَرْنَ كالجَزْعِ المُفَصَّل بَيْنَهُ    بِجِيْدِ مُعَمٍّ في العَشِيْرَةِ مُخْوَلِ",
"فألحَقَه بالهَادِيَاتِ ودُونَهُ    جَوَاحِرُهَا في صَرَّةٍ لم تَزَيَّلِ",
"فَعَادَى عِدَاءً بَيْنَ ثَوْرٍ وَنَعْجَةٍ    دِرَاكاً ولم يُنْضَحْ بِمَاءٍ فيُغْسَلِ",
"فظَلَّ طُهَاةُ اللَّحْمِ مِنْ بَيْنِ مُنْضِجٍ    صَفِيْفَ شِوَاءٍ أو قَدِيْرٍ مُعَجَّلِ",
"ورُحْنَا يَكَادُ الطَّرْفُ يَقْصُرُ دُوْنَهُ    مَتَى مَا تَرَقَّ العَيْنُ فِيْه تَسَهَّلِ",
"فَبَات عَلَيْهِ سَرْجُهُ وَلِجَامُهُ    وبَاتَ بِعَيْنِيْ قَائِمًا غَيْرَ مُرْسَلِ",
"أصَاحَ تَرَى بَرْقًا أرِيْكَ وَمِيْضَهُ    كَلَمْعِ اليَدَيْنِ في حَبِيٍّ مُكَلَّلِ",
"يُضِيءُ سَنَاهُ أو مَصَابِيْحُ راهبٍ    أمَالَ السَّلِيْطَ بالذُّبالِ المُفَتَّلِ",
"قَعَدْتُ لَهَا وصُحْبَتِي بَيْنَ ضَارِجٍ    وبَيْنَ العُذّيْبِ بُعْدَ مَا مُتَأمَّلِ",
"عَلَا قَطَنًا بالشَّيْمِ أيْمَنُ صَوْبهِ    وَأيْسرُهُ على السِّتَارِ فَيَذْبُلِ",
"فَأضْحَى يَسُحُّ المَاءَ حَوْلَ كُتَيْفَةٍ    يَكُبُّ عَلَى الأذْقَانِ دَوْحَ الكَنَهْبُلِ",
"ومَرَّ عَلَى القَنَانِ من نَفَيانِهِ    فأنْزَلَ مِنْهُ العُصْمَ مِنْ كلِّ مَنْزِلِ",
"وتَيْمَاءَ لَمْ يَتْرُكْ بِهَا جِذْعَ نَخْلَةٍ    وَلَا أجُمًا إلَّا مَشِيْدًا بجَنْدَلِ",
"كأنَّ ثَبِيَرًا في عَرانِيْنِ وَبْلِهِ    كَبِيْرُ أنَاسٍ في بِجَادٍ مُزَمَّلِ",
"كأنَّ ذُرَا رَأْسِ المُجَيْمِرِ غُدْوَةً    من السَّيْلِ وَالغُثَّاءِ فَلْكَةُ مِغْزَلِ",
"وألْقَى بِصَحْرَاءِ الغَبِيْطِ بَعَاعَهُ    نُزُولَ اليَمَانِيِ ذِيْ العِيَابِ الـمُحَمَّلِ",
"كَأنَّ مَكَاكيَّ الجِوَاءِ غُدَيَّةً    صُبِحْنَ سُلًافًا مِنْ رَحِيقٍ مُفَلْفَلِ",
"كأنَّ السِّبَاعَ فيه غَرْقَى عَشِيَّةً    بأرجَائِهِ القُصْوَى أنَابِيْشُ عُنْصُلِ"
];

const rhetoricElements = [
  "استعارة",
  "تشبيه",
  "كناية",
  "مجاز",
  "تجريد",
  "مقابلة",
  "التهكم",
  "المشاكلة",
  "طباق",
  "المراجعة",
  "التفات",
  "مبالغة",
  "الرجوع",
  "الحذف",
  "جناس",
  "رد الأعجاز على الصدور",
  "التقسيم",
  "تورية",
  "مقابلة تضاد"
];


// =======================================================
let verseIndex = 0;
let elementIndex = 0;
let summaryPending = false;
// =======================================================

// Writes message into the editor
function writeMessage(text) {
    const editor = document.querySelector("#prompt-textarea");
    if (!editor) return alert("❌ Could not find editor.");

    editor.innerHTML = `<p>${text.replace(/\n/g, "<br>")}</p>`;
    editor.dispatchEvent(new Event("input", { bubbles: true }));
    editor.dispatchEvent(new Event("change", { bubbles: true }));
    editor.focus();
}

// Observes when ChatGPT finishes typing
function waitForFinish(callback) {
    const observer = new MutationObserver(() => {
        const typing = document.querySelector("[data-testid='bot-typing']");
        if (!typing) {
            observer.disconnect();
            setTimeout(callback, 400); // small delay to stabilize
        }
    });

    observer.observe(document.querySelector("main"), {
        childList: true,
        subtree: true
    });
}

// Safely click the send button only when ready and arrow exists
function safeClickSend(callback) {
    const btn = document.querySelector("#composer-submit-button");
    const typing = document.querySelector("[data-testid='bot-typing']");
    const arrowPath = document.querySelector("svg path[d='M8.99992 16V6.41407L5.70696 9.70704C5.31643 10.0976 4.68342 10.0976 4.29289 9.70704C3.90237 9.31652 3.90237 8.6835 4.29289 8.29298L9.29289 3.29298L9.36907 3.22462C9.76184 2.90427 10.3408 2.92686 10.707 3.29298L15.707 8.29298L15.7753 8.36915C16.0957 8.76192 16.0731 9.34092 15.707 9.70704C15.3408 10.0732 14.7618 10.0958 14.3691 9.7754L14.2929 9.70704L10.9999 6.41407V16C10.9999 16.5523 10.5522 17 9.99992 17C9.44764 17 8.99992 16.5523 8.99992 16Z']");

    if (!btn) {
        console.log("❌ Send button not found. Retrying in 1s...");
        setTimeout(() => safeClickSend(callback), 1000);
        return;
    }

    if (!arrowPath) {
        console.log("❌ Send arrow not found. Waiting 1s...");
        setTimeout(() => safeClickSend(callback), 1000);
        return;
    }

    if (typing) {
        console.log("⌛ Bot is still typing. Waiting 1s...");
        setTimeout(() => safeClickSend(callback), 1000);
        return;
    }

    // Everything is ready → click
    btn.click();
    if (callback) waitForFinish(callback);
}


// Main runner
function run() {
    // All verses done
    if (verseIndex >= poem.length) {
        console.log("✔️ Done with ALL verses!");
        return;
    }

    // STEP 1 — If summary is pending → send summary
    if (summaryPending) {
        console.log("➡️ Sending summary request...");
        writeMessage("قم بجدول تلخيصي");
        summaryPending = false;
        safeClickSend(run);
        return;
    }

    const verse = poem[verseIndex];

    // STEP 2 — If all elements for the verse are done → prepare summary
    if (elementIndex >= rhetoricElements.length) {
        summaryPending = true;
        elementIndex = 0;
        verseIndex++;
        run();
        return;
    }

    // STEP 3 — Send one rhetorical element for the verse
    const element = rhetoricElements[elementIndex];
    const message = `البيت: ${verse} <br>العنصر البلاغي: ${element}`;

    console.log("➡️ Sending:", message);

    writeMessage(message);
    elementIndex++;

    // Use safe send
    safeClickSend(run);
}

// START
run();